const t=Symbol("Comlink.proxy"),e=Symbol("Comlink.endpoint"),n=Symbol("Comlink.releaseProxy"),r=new WeakSet,s=new Map([["proxy",{canHandle:e=>e&&e[t],serialize(e){const{port1:n,port2:s}=new MessageChannel;return function e(n,s=self){s.addEventListener("message",(function i(o){if(!o||!o.data)return;const{id:c,type:m,path:p}=Object.assign({path:[]},o.data),f=(o.data.argumentList||[]).map(h);let d;try{const r=p.slice(0,-1).reduce((t,e)=>t[e],n),s=p.reduce((t,e)=>t[e],n);switch(m){case 0:d=s;break;case 1:r[p.slice(-1)[0]]=h(o.data.value),d=!0;break;case 2:d=s.apply(r,f);break;case 3:d=function(e){return Object.assign(e,{[t]:!0})}(new s(...f));break;case 4:{const{port1:t,port2:r}=new MessageChannel;e(n,r),d=function(t,e){return l.set(t,e),t}(t,[t])}break;case 5:d=void 0}}catch(t){d=t,r.add(t)}Promise.resolve(d).catch(t=>(r.add(t),t)).then(t=>{const[e,n]=u(t);s.postMessage(Object.assign(Object.assign({},e),{id:c}),n),5===m&&(s.removeEventListener("message",i),a(s))})})),s.start&&s.start()}(e,n),[s,[s]]},deserialize:t=>(t.start(),i(t))}],["throw",{canHandle:t=>r.has(t),serialize(t){const e=t instanceof Error;let n=t;return e&&(n={isError:e,message:t.message,stack:t.stack}),[n,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error,t);throw t}}]]);function a(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function i(t,r){return function t(r,s=[],i=function(){}){let l=!1;const p=new Proxy(i,{get(e,i){if(o(l),i===n)return()=>m(r,{type:5,path:s.map(t=>t.toString())}).then(()=>{a(r),l=!0});if("then"===i){if(0===s.length)return{then:()=>p};const t=m(r,{type:0,path:s.map(t=>t.toString())}).then(h);return t.then.bind(t)}return t(r,[...s,i])},set(t,e,n){o(l);const[a,i]=u(n);return m(r,{type:1,path:[...s,e].map(t=>t.toString()),value:a},i).then(h)},apply(n,a,i){o(l);const u=s[s.length-1];if(u===e)return m(r,{type:4}).then(h);if("bind"===u)return t(r,s.slice(0,-1));const[p,f]=c(i);return m(r,{type:2,path:s.map(t=>t.toString()),argumentList:p},f).then(h)},construct(t,e){o(l);const[n,a]=c(e);return m(r,{type:3,path:s.map(t=>t.toString()),argumentList:n},a).then(h)}});return p}(t,[],r)}function o(t){if(t)throw new Error("Proxy has been released and is not useable")}function c(t){const e=t.map(u);return[e.map(t=>t[0]),(n=e.map(t=>t[1]),Array.prototype.concat.apply([],n))];var n}const l=new WeakMap;function u(t){for(const[e,n]of s)if(n.canHandle(t)){const[r,s]=n.serialize(t);return[{type:3,name:e,value:r},s]}return[{type:0,value:t},l.get(t)||[]]}function h(t){switch(t.type){case 3:return s.get(t.name).deserialize(t.value);case 0:return t.value}}function m(t,e,n){return new Promise(r=>{const s=new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");t.addEventListener("message",(function e(n){n.data&&n.data.id&&n.data.id===s&&(t.removeEventListener("message",e),r(n.data))})),t.start&&t.start(),t.postMessage(Object.assign({id:s},e),n)})}function p(t,e){for(var n=0,r=t.length-1;r>=0;r--){var s=t[r];"."===s?t.splice(r,1):".."===s?(t.splice(r,1),n++):n&&(t.splice(r,1),n--)}if(e)for(;n--;n)t.unshift("..");return t}var f=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,d=function(t){return f.exec(t).slice(1)};function g(){for(var t="",e=!1,n=arguments.length-1;n>=-1&&!e;n--){var r=n>=0?arguments[n]:"/";if("string"!=typeof r)throw new TypeError("Arguments to path.resolve must be strings");r&&(t=r+"/"+t,e="/"===r.charAt(0))}return(e?"/":"")+(t=p(w(t.split("/"),(function(t){return!!t})),!e).join("/"))||"."}function v(t){var e=y(t),n="/"===k(t,-1);return(t=p(w(t.split("/"),(function(t){return!!t})),!e).join("/"))||e||(t="."),t&&n&&(t+="/"),(e?"/":"")+t}function y(t){return"/"===t.charAt(0)}var b={extname:function(t){return d(t)[3]},basename:function(t,e){var n=d(t)[2];return e&&n.substr(-1*e.length)===e&&(n=n.substr(0,n.length-e.length)),n},dirname:function(t){var e=d(t),n=e[0],r=e[1];return n||r?(r&&(r=r.substr(0,r.length-1)),n+r):"."},sep:"/",delimiter:":",relative:function(t,e){function n(t){for(var e=0;e<t.length&&""===t[e];e++);for(var n=t.length-1;n>=0&&""===t[n];n--);return e>n?[]:t.slice(e,n-e+1)}t=g(t).substr(1),e=g(e).substr(1);for(var r=n(t.split("/")),s=n(e.split("/")),a=Math.min(r.length,s.length),i=a,o=0;o<a;o++)if(r[o]!==s[o]){i=o;break}var c=[];for(o=i;o<r.length;o++)c.push("..");return(c=c.concat(s.slice(i))).join("/")},join:function(){return v(w(Array.prototype.slice.call(arguments,0),(function(t,e){if("string"!=typeof t)throw new TypeError("Arguments to path.join must be strings");return t})).join("/"))},isAbsolute:y,normalize:v,resolve:g};function w(t,e){if(t.filter)return t.filter(e);for(var n=[],r=0;r<t.length;r++)e(t[r],r,t)&&n.push(t[r]);return n}var A,k="b"==="ab".substr(-1)?function(t,e,n){return t.substr(e,n)}:function(t,e,n){return e<0&&(e=t.length+e),t.substr(e,n)};(A=function(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}(b.join(__dirname,"src","lzma_worker.js")).LZMA_WORKER).compress;var E=A.decompress;const L="position: absolute; top: 5vh; left: 5vw; width: 90vw; height: 90vh; border: 2px solid #0A78FC; box-shadow: 10px 10px 10px 0em rgba(0,0,0,0.5);";class j{constructor(t){this.data=t}}class S{constructor(t){this.apiURL=t,this.iframe=null,this.comlink=null}static async decompress(t){return new Promise(e=>E(t,e))}async getComlink(){return this.comlink||await(async()=>{const t=this.iframe=document.createElement("iframe");return t.setAttribute("sandbox","allow-scripts allow-same-origin"),t.setAttribute("referrerpolicy","strict-origin"),t.src=this.apiURL,t.setAttribute("style",L),t.style.visibility="hidden",document.body.appendChild(t),this.comlink=await new Promise((e,n)=>{t.onload=async function(){const n=i(function(t,e=self,n="*"){return{postMessage:(e,r)=>t.postMessage(e,n,r),addEventListener:e.addEventListener.bind(e),removeEventListener:e.removeEventListener.bind(e)}}(t.contentWindow));e(n)},t.onerror=function(t){n(Error("Iframe failed to load: "+t.message))}}),this.comlink})()}async canLoad(){const t=await this.getComlink();if(console.log(await t.testVal),!await t.canDoLocalStorage()){const t=new URL(location.href);return location.assign(this.apiURL+"?redirect="+encodeURIComponent(t.origin+t.pathname)),{result:!1,message:"Redirecting to get avatar"}}{const e=await t.hasAvatar();console.log({hasAvatar:e});const n=await t.hasPermission();if(console.log({hasPermission:n}),e&&n)return{result:!0};this.iframe.style.visibility="";try{return await t.getPermission(),console.log("Permission Granted!!"),this.iframe.style.visibility="hidden",{result:!0}}catch(t){return this.iframe.style.visibility="hidden",{result:!1,message:t.message}}}}async loadAvatarFromBase64(t){const e=[...atob(t)].map(t=>t.charCodeAt(0)-128),n=await S.decompress(e);return new j(JSON.parse(n))}async getAvatarAsJSON(){const t=await this.getComlink();return new j(await t.getAvatarAsJSON())}destroy(){this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,this.comlink=null}}export{S as AvatarLoader};
