const e=Symbol("Comlink.proxy"),t=Symbol("Comlink.endpoint"),r=Symbol("Comlink.releaseProxy"),n=new WeakSet,o=new Map([["proxy",{canHandle:t=>t&&t[e],serialize(t){const{port1:r,port2:o}=new MessageChannel;return function t(r,o=self){o.addEventListener("message",(function i(a){if(!a||!a.data)return;const{id:c,type:f,path:l}=Object.assign({path:[]},a.data),p=(a.data.argumentList||[]).map(m);let _;try{const n=l.slice(0,-1).reduce((e,t)=>e[t],r),o=l.reduce((e,t)=>e[t],r);switch(f){case 0:_=o;break;case 1:n[l.slice(-1)[0]]=m(a.data.value),_=!0;break;case 2:_=o.apply(n,p);break;case 3:_=function(t){return Object.assign(t,{[e]:!0})}(new o(...p));break;case 4:{const{port1:e,port2:n}=new MessageChannel;t(r,n),_=function(e,t){return u.set(e,t),e}(e,[e])}break;case 5:_=void 0}}catch(e){_=e,n.add(e)}Promise.resolve(_).catch(e=>(n.add(e),e)).then(e=>{const[t,r]=d(e);o.postMessage(Object.assign(Object.assign({},t),{id:c}),r),5===f&&(o.removeEventListener("message",i),s(o))})})),o.start&&o.start()}(t,r),[o,[o]]},deserialize:e=>(e.start(),i(e))}],["throw",{canHandle:e=>n.has(e),serialize(e){const t=e instanceof Error;let r=e;return t&&(r={isError:t,message:e.message,stack:e.stack}),[r,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error,e);throw e}}]]);function s(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function i(e,n){return function e(n,o=[],i=function(){}){let u=!1;const l=new Proxy(i,{get(t,i){if(a(u),i===r)return()=>f(n,{type:5,path:o.map(e=>e.toString())}).then(()=>{s(n),u=!0});if("then"===i){if(0===o.length)return{then:()=>l};const e=f(n,{type:0,path:o.map(e=>e.toString())}).then(m);return e.then.bind(e)}return e(n,[...o,i])},set(e,t,r){a(u);const[s,i]=d(r);return f(n,{type:1,path:[...o,t].map(e=>e.toString()),value:s},i).then(m)},apply(r,s,i){a(u);const d=o[o.length-1];if(d===t)return f(n,{type:4}).then(m);if("bind"===d)return e(n,o.slice(0,-1));const[l,p]=c(i);return f(n,{type:2,path:o.map(e=>e.toString()),argumentList:l},p).then(m)},construct(e,t){a(u);const[r,s]=c(t);return f(n,{type:3,path:o.map(e=>e.toString()),argumentList:r},s).then(m)}});return l}(e,[],n)}function a(e){if(e)throw new Error("Proxy has been released and is not useable")}function c(e){const t=e.map(d);return[t.map(e=>e[0]),(r=t.map(e=>e[1]),Array.prototype.concat.apply([],r))];var r}const u=new WeakMap;function d(e){for(const[t,r]of o)if(r.canHandle(e)){const[n,o]=r.serialize(e);return[{type:3,name:t,value:n},o]}return[{type:0,value:e},u.get(e)||[]]}function m(e){switch(e.type){case 3:return o.get(e.name).deserialize(e.value);case 0:return e.value}}function f(e,t,r){return new Promise(n=>{const o=new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");e.addEventListener("message",(function t(r){r.data&&r.data.id&&r.data.id===o&&(e.removeEventListener("message",t),n(r.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:o},t),r)})}var l="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},p=function(){var e=2,t=3,r="function"==typeof setImmediate?setImmediate:setTimeout,n=4294967296,o=[4294967295,-n],s=[0,0],i=[1,0];function a(e){var t=[];return t[e-1]=void 0,t}function c(e,t){return d(e[0]+t[0],e[1]+t[1])}function u(e,t){var r,n;return e[0]==t[0]&&e[1]==t[1]?0:(r=e[1]<0,n=t[1]<0,r&&!n?-1:!r&&n?1:function(e,t){return d(e[0]-t[0],e[1]-t[1])}(e,t)[1]<0?-1:1)}function d(e,t){var r,o;for(e%=0x10000000000000000,t=(t%=0x10000000000000000)-(r=t%n)+(o=Math.floor(e/n)*n),e=e-o+r;e<0;)e+=n,t-=n;for(;e>4294967295;)e-=n,t+=n;for(t%=0x10000000000000000;t>0x7fffffff00000000;)t-=0x10000000000000000;for(;t<-0x8000000000000000;)t+=0x10000000000000000;return[e,t]}function m(e){return e>=0?[e,0]:[e+n,-n]}function f(e){return e[0]>=2147483648?~~Math.max(Math.min(e[0]-n,2147483647),-2147483648):~~Math.max(Math.min(e[0],2147483647),-2147483648)}function l(e){return e.pos>=e.count?-1:255&e.buf[e.pos++]}function _(e){var t=e.buf;return t.length=e.count,t}function g(e,t,r){var n,i,c,u,d="",f=[];for(i=0;i<5;++i){if(-1==(c=l(t)))throw new Error("truncated input");f[i]=c<<24>>24}if(!function(e,t){var r,n,o,s,i,c,u;if(t.length<5)return 0;for(u=255&t[0],o=u%9,s=(c=~~(u/9))%5,i=~~(c/5),r=0,n=0;n<4;++n)r+=(255&t[1+n])<<8*n;if(r>99999999||!function(e,t,r,n){if(t>8||r>4||n>4)return 0;!function(e,t,r){var n,o;if(null!=e.m_Coders&&e.m_NumPrevBits==r&&e.m_NumPosBits==t)return;for(e.m_NumPosBits=t,e.m_PosMask=(1<<t)-1,e.m_NumPrevBits=r,o=1<<e.m_NumPrevBits+e.m_NumPosBits,e.m_Coders=a(o),n=0;n<o;++n)e.m_Coders[n]=C({})}(e.m_LiteralDecoder,r,t);var o=1<<n;return P(e.m_LenDecoder,o),P(e.m_RepLenDecoder,o),e.m_PosStateMask=o-1,1}(e,o,s,i))return 0;return function(e,t){if(t<0)return 0;e.m_DictionarySize!=t&&(e.m_DictionarySize=t,e.m_DictionarySizeCheck=Math.max(e.m_DictionarySize,1),function(e,t){null!=e._buffer&&e._windowSize==t||(e._buffer=a(t));e._windowSize=t,e._pos=0,e._streamPos=0}(e.m_OutWindow,Math.max(e.m_DictionarySizeCheck,4096)));return 1}(e,r)}(n=function(e){e.m_OutWindow={},e.m_RangeDecoder={},e.m_IsMatchDecoders=a(192),e.m_IsRepDecoders=a(12),e.m_IsRepG0Decoders=a(12),e.m_IsRepG1Decoders=a(12),e.m_IsRepG2Decoders=a(12),e.m_IsRep0LongDecoders=a(192),e.m_PosSlotDecoder=a(4),e.m_PosDecoders=a(114),e.m_PosAlignDecoder=L({},4),e.m_LenDecoder=b({}),e.m_RepLenDecoder=b({}),e.m_LiteralDecoder={};for(var t=0;t<4;++t)e.m_PosSlotDecoder[t]=L({},6);return e}({}),f))throw new Error("corrupted input");for(i=0;i<64;i+=8){if(-1==(c=l(t)))throw new Error("truncated input");1==(c=c.toString(16)).length&&(c="0"+c),d=c+""+d}/^0+$|^f+$/i.test(d)?e.length_0=o:(u=parseInt(d,16),e.length_0=u>4294967295?o:m(u)),e.chunker=function(e,t,r,n){return e.m_RangeDecoder.Stream=t,D(e.m_OutWindow),e.m_OutWindow._stream=r,function(e){e.m_OutWindow._streamPos=0,e.m_OutWindow._pos=0,N(e.m_IsMatchDecoders),N(e.m_IsRep0LongDecoders),N(e.m_IsRepDecoders),N(e.m_IsRepG0Decoders),N(e.m_IsRepG1Decoders),N(e.m_IsRepG2Decoders),N(e.m_PosDecoders),function(e){var t,r;for(r=1<<e.m_NumPrevBits+e.m_NumPosBits,t=0;t<r;++t)N(e.m_Coders[t].m_Decoders)}(e.m_LiteralDecoder);for(var t=0;t<4;++t)N(e.m_PosSlotDecoder[t].Models);S(e.m_LenDecoder),S(e.m_RepLenDecoder),N(e.m_PosAlignDecoder.Models),function(e){e.Code=0,e.Range=-1;for(var t=0;t<5;++t)e.Code=e.Code<<8|l(e.Stream)}(e.m_RangeDecoder)}(e),e.state=0,e.rep0=0,e.rep1=0,e.rep2=0,e.rep3=0,e.outSize=n,e.nowPos64=s,e.prevByte=0,function(e,t){return e.decoder=t,e.encoder=null,e.alive=1,e}({},e)}(n,t,r,e.length_0)}function h(e,t){return e.output=function(e){return e.buf=a(32),e.count=0,e}({}),g(e,function(e,t){return e.buf=t,e.pos=0,e.count=t.length,e}({},t),e.output),e}function w(e){var t=e._pos-e._streamPos;t&&(!function(e,t,r,n){!function(e,t,r,n,o){for(var s=0;s<o;++s)r[n+s]=e[t+s]}(t,r,e.buf,e.count,n),e.count+=n}(e._stream,e._buffer,e._streamPos,t),e._pos>=e._windowSize&&(e._pos=0),e._streamPos=e._pos)}function v(e,t){var r=e._pos-t-1;return r<0&&(r+=e._windowSize),e._buffer[r]}function D(e){w(e),e._stream=null}function y(e){if(!e.alive)throw new Error("bad state");if(e.encoder)throw new Error("No encoding");return(function(e){var t=function(e){var t,r,n,o,s,a;if(a=f(e.nowPos64)&e.m_PosStateMask,k(e.m_RangeDecoder,e.m_IsMatchDecoders,(e.state<<4)+a)){if(k(e.m_RangeDecoder,e.m_IsRepDecoders,e.state))n=0,k(e.m_RangeDecoder,e.m_IsRepG0Decoders,e.state)?(k(e.m_RangeDecoder,e.m_IsRepG1Decoders,e.state)?(k(e.m_RangeDecoder,e.m_IsRepG2Decoders,e.state)?(r=e.rep3,e.rep3=e.rep2):r=e.rep2,e.rep2=e.rep1):r=e.rep1,e.rep1=e.rep0,e.rep0=r):k(e.m_RangeDecoder,e.m_IsRep0LongDecoders,(e.state<<4)+a)||(e.state=e.state<7?9:11,n=1),n||(n=R(e.m_RepLenDecoder,e.m_RangeDecoder,a)+2,e.state=e.state<7?8:11);else if(e.rep3=e.rep2,e.rep2=e.rep1,e.rep1=e.rep0,n=2+R(e.m_LenDecoder,e.m_RangeDecoder,a),e.state=e.state<7?7:10,(s=M(e.m_PosSlotDecoder[function(e){return(e-=2)<4?e:3}(n)],e.m_RangeDecoder))>=4){if(o=(s>>1)-1,e.rep0=(2|1&s)<<o,s<14)e.rep0+=function(e,t,r,n){var o,s,i=1,a=0;for(s=0;s<n;++s)o=k(r,e,t+i),i<<=1,i+=o,a|=o<<s;return a}(e.m_PosDecoders,e.rep0-s-1,e.m_RangeDecoder,o);else if(e.rep0+=function(e,t){var r,n,o=0;for(r=t;0!=r;--r)e.Range>>>=1,n=e.Code-e.Range>>>31,e.Code-=e.Range&n-1,o=o<<1|1-n,-16777216&e.Range||(e.Code=e.Code<<8|l(e.Stream),e.Range<<=8);return o}(e.m_RangeDecoder,o-4)<<4,e.rep0+=function(e,t){var r,n,o=1,s=0;for(n=0;n<e.NumBitLevels;++n)r=k(t,e.Models,o),o<<=1,o+=r,s|=r<<n;return s}(e.m_PosAlignDecoder,e.m_RangeDecoder),e.rep0<0)return-1==e.rep0?1:-1}else e.rep0=s;if(u(m(e.rep0),e.nowPos64)>=0||e.rep0>=e.m_DictionarySizeCheck)return-1;!function(e,t,r){var n=e._pos-t-1;for(n<0&&(n+=e._windowSize);0!=r;--r)n>=e._windowSize&&(n=0),e._buffer[e._pos++]=e._buffer[n++],e._pos>=e._windowSize&&w(e)}(e.m_OutWindow,e.rep0,n),e.nowPos64=c(e.nowPos64,m(n)),e.prevByte=v(e.m_OutWindow,0)}else t=function(e,t,r){return e.m_Coders[((t&e.m_PosMask)<<e.m_NumPrevBits)+((255&r)>>>8-e.m_NumPrevBits)]}(e.m_LiteralDecoder,f(e.nowPos64),e.prevByte),e.state<7?e.prevByte=function(e,t){var r=1;do{r=r<<1|k(t,e.m_Decoders,r)}while(r<256);return r<<24>>24}(t,e.m_RangeDecoder):e.prevByte=function(e,t,r){var n,o,s=1;do{if(o=r>>7&1,r<<=1,n=k(t,e.m_Decoders,(1+o<<8)+s),s=s<<1|n,o!=n){for(;s<256;)s=s<<1|k(t,e.m_Decoders,s);break}}while(s<256);return s<<24>>24}(t,e.m_RangeDecoder,v(e.m_OutWindow,e.rep0)),function(e,t){e._buffer[e._pos++]=t,e._pos>=e._windowSize&&w(e)}(e.m_OutWindow,e.prevByte),e.state=(d=e.state)<4?0:d<10?d-3:d-6,e.nowPos64=c(e.nowPos64,i);var d;return 0}(e.decoder);if(-1==t)throw new Error("corrupted input");e.inBytesProcessed=o,e.outBytesProcessed=e.decoder.nowPos64,(t||u(e.decoder.outSize,s)>=0&&u(e.decoder.nowPos64,e.decoder.outSize)>=0)&&(w(e.decoder.m_OutWindow),D(e.decoder.m_OutWindow),e.decoder.m_RangeDecoder.Stream=null,e.alive=0)}(e),e.alive)}function P(e,t){for(;e.m_NumPosStates<t;++e.m_NumPosStates)e.m_LowCoder[e.m_NumPosStates]=L({},3),e.m_MidCoder[e.m_NumPosStates]=L({},3)}function R(e,t,r){if(!k(t,e.m_Choice,0))return M(e.m_LowCoder[r],t);var n=8;return k(t,e.m_Choice,1)?n+=8+M(e.m_HighCoder,t):n+=M(e.m_MidCoder[r],t),n}function b(e){return e.m_Choice=a(2),e.m_LowCoder=a(16),e.m_MidCoder=a(16),e.m_HighCoder=L({},8),e.m_NumPosStates=0,e}function S(e){N(e.m_Choice);for(var t=0;t<e.m_NumPosStates;++t)N(e.m_LowCoder[t].Models),N(e.m_MidCoder[t].Models);N(e.m_HighCoder.Models)}function C(e){return e.m_Decoders=a(768),e}function L(e,t){return e.NumBitLevels=t,e.Models=a(1<<t),e}function M(e,t){var r,n=1;for(r=e.NumBitLevels;0!=r;--r)n=(n<<1)+k(t,e.Models,n);return n-(1<<e.NumBitLevels)}function k(e,t,r){var n,o=t[r];return n=(e.Range>>>11)*o,(-2147483648^e.Code)<(-2147483648^n)?(e.Range=n,t[r]=o+(2048-o>>>5)<<16>>16,-16777216&e.Range||(e.Code=e.Code<<8|l(e.Stream),e.Range<<=8),0):(e.Range-=n,e.Code-=n,t[r]=o-(o>>>5)<<16>>16,-16777216&e.Range||(e.Code=e.Code<<8|l(e.Stream),e.Range<<=8),1)}function N(e){for(var t=e.length-1;t>=0;--t)e[t]=1024}function E(e){for(var t,r,n,o=0,s=0,i=e.length,a=[],c=[];o<i;++o,++s){if(128&(t=255&e[o]))if(192==(224&t)){if(o+1>=i)return e;if(128!=(192&(r=255&e[++o])))return e;c[s]=(31&t)<<6|63&r}else{if(224!=(240&t))return e;if(o+2>=i)return e;if(128!=(192&(r=255&e[++o])))return e;if(128!=(192&(n=255&e[++o])))return e;c[s]=(15&t)<<12|(63&r)<<6|63&n}else{if(!t)return e;c[s]=t}16383==s&&(a.push(String.fromCharCode.apply(String,c)),s=-1)}return s>0&&(c.length=s,a.push(String.fromCharCode.apply(String,c))),a.join("")}function I(e){return e[1]+e[0]}return"undefined"==typeof onmessage||"undefined"!=typeof window&&void 0!==window.document||(onmessage=function(t){t&&t.data&&t.data.action==e&&p.decompress(t.data.data,t.data.cbn)}),{decompress:function(n,o,s){var i,a,c,u,d={},m=void 0===o&&void 0===s;if("function"!=typeof o&&(a=o,o=s=0),s=s||function(e){if(void 0!==a)return function(e,r){postMessage({action:t,cbn:r,result:e})}(c?e:-1,a)},o=o||function(t,r){if(void 0!==a)return postMessage({action:e,cbn:a,result:t,error:r})},m){for(d.d=h({},n);y(d.d.chunker););return E(_(d.d.output))}try{d.d=h({},n),u=I(d.d.length_0),c=u>-1,s(0)}catch(e){return o(null,e)}r((function e(){try{for(var t,n=0,a=(new Date).getTime();y(d.d.chunker);)if(++n%1e3==0&&(new Date).getTime()-a>200)return c&&(i=I(d.d.chunker.decoder.nowPos64)/u,s(i)),r(e,0),0;s(1),t=E(_(d.d.output)),r(o.bind(null,t),0)}catch(e){o(null,e)}}),0)}}}();l.LZMA=l.LZMA_WORKER=p;const _="position: absolute; top: 5vh; left: 5vw; width: 90vw; height: 90vh; border: 2px solid #0A78FC; box-shadow: 10px 10px 10px 0em rgba(0,0,0,0.5);";class g{constructor(e){this.data=e}}class h{constructor(e){this.apiURL=e,this.iframe=null,this.comlink=null}static async decompress(e){return new Promise(t=>LZMA.decompress(e,t))}async getComlink(){return this.comlink||await(async()=>{const e=this.iframe=document.createElement("iframe");return e.setAttribute("sandbox","allow-scripts allow-same-origin"),e.setAttribute("referrerpolicy","strict-origin"),e.src=this.apiURL,e.setAttribute("style",_),e.style.visibility="hidden",document.body.appendChild(e),this.comlink=await new Promise((t,r)=>{e.onload=async function(){const r=i(function(e,t=self,r="*"){return{postMessage:(t,n)=>e.postMessage(t,r,n),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}(e.contentWindow));t(r)},e.onerror=function(e){r(Error("Iframe failed to load: "+e.message))}}),this.comlink})()}async canLoad(){const e=await this.getComlink();if(console.log(await e.testVal),!await e.canDoLocalStorage()){const e=new URL(location.href);return location.assign(this.apiURL+"?redirect="+encodeURIComponent(e.origin+e.pathname)),{result:!1,message:"Redirecting to get avatar"}}{const t=await e.hasAvatar();console.log({hasAvatar:t});const r=await e.hasPermission();if(console.log({hasPermission:r}),t&&r)return{result:!0};this.iframe.style.visibility="";try{return await e.getPermission(),console.log("Permission Granted!!"),this.iframe.style.visibility="hidden",{result:!0}}catch(e){return this.iframe.style.visibility="hidden",{result:!1,message:e.message}}}}async loadAvatarFromBase64(e){const t=[...atob(e)].map(e=>e.charCodeAt(0)-128),r=await h.decompress(t);return new g(JSON.parse(r))}async getAvatarAsJSON(){const e=await this.getComlink();return new g(await e.getAvatarAsJSON())}destroy(){this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,this.comlink=null}}export{h as AvatarLoader};
