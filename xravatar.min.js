var XRAvatar=function(t){"use strict";const e=Symbol("Comlink.proxy"),n=Symbol("Comlink.endpoint"),r=Symbol("Comlink.releaseProxy"),s=new WeakSet,a=new Map([["proxy",{canHandle:t=>t&&t[e],serialize(t){const{port1:n,port2:r}=new MessageChannel;return function t(n,r=self){r.addEventListener("message",(function a(o){if(!o||!o.data)return;const{id:c,type:u,path:p}=Object.assign({path:[]},o.data),f=(o.data.argumentList||[]).map(m);let d;try{const r=p.slice(0,-1).reduce((t,e)=>t[e],n),s=p.reduce((t,e)=>t[e],n);switch(u){case 0:d=s;break;case 1:r[p.slice(-1)[0]]=m(o.data.value),d=!0;break;case 2:d=s.apply(r,f);break;case 3:d=function(t){return Object.assign(t,{[e]:!0})}(new s(...f));break;case 4:{const{port1:e,port2:r}=new MessageChannel;t(n,r),d=function(t,e){return l.set(t,e),t}(e,[e])}break;case 5:d=void 0}}catch(t){d=t,s.add(t)}Promise.resolve(d).catch(t=>(s.add(t),t)).then(t=>{const[e,n]=h(t);r.postMessage(Object.assign(Object.assign({},e),{id:c}),n),5===u&&(r.removeEventListener("message",a),i(r))})})),r.start&&r.start()}(t,n),[r,[r]]},deserialize:t=>(t.start(),o(t))}],["throw",{canHandle:t=>s.has(t),serialize(t){const e=t instanceof Error;let n=t;return e&&(n={isError:e,message:t.message,stack:t.stack}),[n,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error,t);throw t}}]]);function i(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function o(t,e){return function t(e,s=[],a=function(){}){let o=!1;const l=new Proxy(a,{get(n,a){if(c(o),a===r)return()=>p(e,{type:5,path:s.map(t=>t.toString())}).then(()=>{i(e),o=!0});if("then"===a){if(0===s.length)return{then:()=>l};const t=p(e,{type:0,path:s.map(t=>t.toString())}).then(m);return t.then.bind(t)}return t(e,[...s,a])},set(t,n,r){c(o);const[a,i]=h(r);return p(e,{type:1,path:[...s,n].map(t=>t.toString()),value:a},i).then(m)},apply(r,a,i){c(o);const l=s[s.length-1];if(l===n)return p(e,{type:4}).then(m);if("bind"===l)return t(e,s.slice(0,-1));const[h,f]=u(i);return p(e,{type:2,path:s.map(t=>t.toString()),argumentList:h},f).then(m)},construct(t,n){c(o);const[r,a]=u(n);return p(e,{type:3,path:s.map(t=>t.toString()),argumentList:r},a).then(m)}});return l}(t,[],e)}function c(t){if(t)throw new Error("Proxy has been released and is not useable")}function u(t){const e=t.map(h);return[e.map(t=>t[0]),(n=e.map(t=>t[1]),Array.prototype.concat.apply([],n))];var n}const l=new WeakMap;function h(t){for(const[e,n]of a)if(n.canHandle(t)){const[r,s]=n.serialize(t);return[{type:3,name:e,value:r},s]}return[{type:0,value:t},l.get(t)||[]]}function m(t){switch(t.type){case 3:return a.get(t.name).deserialize(t.value);case 0:return t.value}}function p(t,e,n){return new Promise(r=>{const s=new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");t.addEventListener("message",(function e(n){n.data&&n.data.id&&n.data.id===s&&(t.removeEventListener("message",e),r(n.data))})),t.start&&t.start(),t.postMessage(Object.assign({id:s},e),n)})}function f(t,e){for(var n=0,r=t.length-1;r>=0;r--){var s=t[r];"."===s?t.splice(r,1):".."===s?(t.splice(r,1),n++):n&&(t.splice(r,1),n--)}if(e)for(;n--;n)t.unshift("..");return t}var d=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,g=function(t){return d.exec(t).slice(1)};function v(){for(var t="",e=!1,n=arguments.length-1;n>=-1&&!e;n--){var r=n>=0?arguments[n]:"/";if("string"!=typeof r)throw new TypeError("Arguments to path.resolve must be strings");r&&(t=r+"/"+t,e="/"===r.charAt(0))}return(e?"/":"")+(t=f(A(t.split("/"),(function(t){return!!t})),!e).join("/"))||"."}function y(t){var e=b(t),n="/"===E(t,-1);return(t=f(A(t.split("/"),(function(t){return!!t})),!e).join("/"))||e||(t="."),t&&n&&(t+="/"),(e?"/":"")+t}function b(t){return"/"===t.charAt(0)}var w={extname:function(t){return g(t)[3]},basename:function(t,e){var n=g(t)[2];return e&&n.substr(-1*e.length)===e&&(n=n.substr(0,n.length-e.length)),n},dirname:function(t){var e=g(t),n=e[0],r=e[1];return n||r?(r&&(r=r.substr(0,r.length-1)),n+r):"."},sep:"/",delimiter:":",relative:function(t,e){function n(t){for(var e=0;e<t.length&&""===t[e];e++);for(var n=t.length-1;n>=0&&""===t[n];n--);return e>n?[]:t.slice(e,n-e+1)}t=v(t).substr(1),e=v(e).substr(1);for(var r=n(t.split("/")),s=n(e.split("/")),a=Math.min(r.length,s.length),i=a,o=0;o<a;o++)if(r[o]!==s[o]){i=o;break}var c=[];for(o=i;o<r.length;o++)c.push("..");return(c=c.concat(s.slice(i))).join("/")},join:function(){return y(A(Array.prototype.slice.call(arguments,0),(function(t,e){if("string"!=typeof t)throw new TypeError("Arguments to path.join must be strings");return t})).join("/"))},isAbsolute:b,normalize:y,resolve:v};function A(t,e){if(t.filter)return t.filter(e);for(var n=[],r=0;r<t.length;r++)e(t[r],r,t)&&n.push(t[r]);return n}var k,E="b"==="ab".substr(-1)?function(t,e,n){return t.substr(e,n)}:function(t,e,n){return e<0&&(e=t.length+e),t.substr(e,n)};(k=function(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}(w.join(__dirname,"src","lzma_worker.js")).LZMA_WORKER).compress;var L=k.decompress;const j="position: absolute; top: 5vh; left: 5vw; width: 90vw; height: 90vh; border: 2px solid #0A78FC; box-shadow: 10px 10px 10px 0em rgba(0,0,0,0.5);";class S{constructor(t){this.data=t}}class M{constructor(t){this.apiURL=t,this.iframe=null,this.comlink=null}static async decompress(t){return new Promise(e=>L(t,e))}async getComlink(){return this.comlink||await(async()=>{const t=this.iframe=document.createElement("iframe");return t.setAttribute("sandbox","allow-scripts allow-same-origin"),t.setAttribute("referrerpolicy","strict-origin"),t.src=this.apiURL,t.setAttribute("style",j),t.style.visibility="hidden",document.body.appendChild(t),this.comlink=await new Promise((e,n)=>{t.onload=async function(){const n=o(function(t,e=self,n="*"){return{postMessage:(e,r)=>t.postMessage(e,n,r),addEventListener:e.addEventListener.bind(e),removeEventListener:e.removeEventListener.bind(e)}}(t.contentWindow));e(n)},t.onerror=function(t){n(Error("Iframe failed to load: "+t.message))}}),this.comlink})()}async canLoad(){const t=await this.getComlink();if(console.log(await t.testVal),!await t.canDoLocalStorage()){const t=new URL(location.href);return location.assign(this.apiURL+"?redirect="+encodeURIComponent(t.origin+t.pathname)),{result:!1,message:"Redirecting to get avatar"}}{const e=await t.hasAvatar();console.log({hasAvatar:e});const n=await t.hasPermission();if(console.log({hasPermission:n}),e&&n)return{result:!0};this.iframe.style.visibility="";try{return await t.getPermission(),console.log("Permission Granted!!"),this.iframe.style.visibility="hidden",{result:!0}}catch(t){return this.iframe.style.visibility="hidden",{result:!1,message:t.message}}}}async loadAvatarFromBase64(t){const e=[...atob(t)].map(t=>t.charCodeAt(0)-128),n=await M.decompress(e);return new S(JSON.parse(n))}async getAvatarAsJSON(){const t=await this.getComlink();return new S(await t.getAvatarAsJSON())}destroy(){this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,this.comlink=null}}return t.AvatarLoader=M,t}({});
