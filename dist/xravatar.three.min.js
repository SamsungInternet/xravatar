const e=Symbol("Comlink.proxy"),t=Symbol("Comlink.endpoint"),r=Symbol("Comlink.releaseProxy"),n=new WeakSet,o=new Map([["proxy",{canHandle:t=>t&&t[e],serialize(t){const{port1:r,port2:o}=new MessageChannel;return function t(r,o=self){o.addEventListener("message",(function i(s){if(!s||!s.data)return;const{id:c,type:l,path:f}=Object.assign({path:[]},s.data),p=(s.data.argumentList||[]).map(d);let _;try{const n=f.slice(0,-1).reduce((e,t)=>e[t],r),o=f.reduce((e,t)=>e[t],r);switch(l){case 0:_=o;break;case 1:n[f.slice(-1)[0]]=d(s.data.value),_=!0;break;case 2:_=o.apply(n,p);break;case 3:_=function(t){return Object.assign(t,{[e]:!0})}(new o(...p));break;case 4:{const{port1:e,port2:n}=new MessageChannel;t(r,n),_=function(e,t){return u.set(e,t),e}(e,[e])}break;case 5:_=void 0}}catch(e){_=e,n.add(e)}Promise.resolve(_).catch(e=>(n.add(e),e)).then(e=>{const[t,r]=m(e);o.postMessage(Object.assign(Object.assign({},t),{id:c}),r),5===l&&(o.removeEventListener("message",i),a(o))})})),o.start&&o.start()}(t,r),[o,[o]]},deserialize:e=>(e.start(),i(e))}],["throw",{canHandle:e=>n.has(e),serialize(e){const t=e instanceof Error;let r=e;return t&&(r={isError:t,message:e.message,stack:e.stack}),[r,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error,e);throw e}}]]);function a(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function i(e,n){return function e(n,o=[],i=function(){}){let u=!1;const f=new Proxy(i,{get(t,i){if(s(u),i===r)return()=>l(n,{type:5,path:o.map(e=>e.toString())}).then(()=>{a(n),u=!0});if("then"===i){if(0===o.length)return{then:()=>f};const e=l(n,{type:0,path:o.map(e=>e.toString())}).then(d);return e.then.bind(e)}return e(n,[...o,i])},set(e,t,r){s(u);const[a,i]=m(r);return l(n,{type:1,path:[...o,t].map(e=>e.toString()),value:a},i).then(d)},apply(r,a,i){s(u);const m=o[o.length-1];if(m===t)return l(n,{type:4}).then(d);if("bind"===m)return e(n,o.slice(0,-1));const[f,p]=c(i);return l(n,{type:2,path:o.map(e=>e.toString()),argumentList:f},p).then(d)},construct(e,t){s(u);const[r,a]=c(t);return l(n,{type:3,path:o.map(e=>e.toString()),argumentList:r},a).then(d)}});return f}(e,[],n)}function s(e){if(e)throw new Error("Proxy has been released and is not useable")}function c(e){const t=e.map(m);return[t.map(e=>e[0]),(r=t.map(e=>e[1]),Array.prototype.concat.apply([],r))];var r}const u=new WeakMap;function m(e){for(const[t,r]of o)if(r.canHandle(e)){const[n,o]=r.serialize(e);return[{type:3,name:t,value:n},o]}return[{type:0,value:e},u.get(e)||[]]}function d(e){switch(e.type){case 3:return o.get(e.name).deserialize(e.value);case 0:return e.value}}function l(e,t,r){return new Promise(n=>{const o=new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");e.addEventListener("message",(function t(r){r.data&&r.data.id&&r.data.id===o&&(e.removeEventListener("message",t),n(r.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:o},t),r)})}var f="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},p=function(){var e=2,t=3,r="function"==typeof setImmediate?setImmediate:setTimeout,n=4294967296,o=[4294967295,-n],a=[0,0],i=[1,0];function s(e){var t=[];return t[e-1]=void 0,t}function c(e,t){return m(e[0]+t[0],e[1]+t[1])}function u(e,t){var r,n;return e[0]==t[0]&&e[1]==t[1]?0:(r=e[1]<0,n=t[1]<0,r&&!n?-1:!r&&n?1:function(e,t){return m(e[0]-t[0],e[1]-t[1])}(e,t)[1]<0?-1:1)}function m(e,t){var r,o;for(e%=0x10000000000000000,t=(t%=0x10000000000000000)-(r=t%n)+(o=Math.floor(e/n)*n),e=e-o+r;e<0;)e+=n,t-=n;for(;e>4294967295;)e-=n,t+=n;for(t%=0x10000000000000000;t>0x7fffffff00000000;)t-=0x10000000000000000;for(;t<-0x8000000000000000;)t+=0x10000000000000000;return[e,t]}function d(e){return e>=0?[e,0]:[e+n,-n]}function l(e){return e[0]>=2147483648?~~Math.max(Math.min(e[0]-n,2147483647),-2147483648):~~Math.max(Math.min(e[0],2147483647),-2147483648)}function f(e){return e.pos>=e.count?-1:255&e.buf[e.pos++]}function _(e){var t=e.buf;return t.length=e.count,t}function h(e,t,r){var n,i,c,u,m="",l=[];for(i=0;i<5;++i){if(-1==(c=f(t)))throw new Error("truncated input");l[i]=c<<24>>24}if(!function(e,t){var r,n,o,a,i,c,u;if(t.length<5)return 0;for(u=255&t[0],o=u%9,a=(c=~~(u/9))%5,i=~~(c/5),r=0,n=0;n<4;++n)r+=(255&t[1+n])<<8*n;if(r>99999999||!function(e,t,r,n){if(t>8||r>4||n>4)return 0;!function(e,t,r){var n,o;if(null!=e.m_Coders&&e.m_NumPrevBits==r&&e.m_NumPosBits==t)return;for(e.m_NumPosBits=t,e.m_PosMask=(1<<t)-1,e.m_NumPrevBits=r,o=1<<e.m_NumPrevBits+e.m_NumPosBits,e.m_Coders=s(o),n=0;n<o;++n)e.m_Coders[n]=R({})}(e.m_LiteralDecoder,r,t);var o=1<<n;return D(e.m_LenDecoder,o),D(e.m_RepLenDecoder,o),e.m_PosStateMask=o-1,1}(e,o,a,i))return 0;return function(e,t){if(t<0)return 0;e.m_DictionarySize!=t&&(e.m_DictionarySize=t,e.m_DictionarySizeCheck=Math.max(e.m_DictionarySize,1),function(e,t){null!=e._buffer&&e._windowSize==t||(e._buffer=s(t));e._windowSize=t,e._pos=0,e._streamPos=0}(e.m_OutWindow,Math.max(e.m_DictionarySizeCheck,4096)));return 1}(e,r)}(n=function(e){e.m_OutWindow={},e.m_RangeDecoder={},e.m_IsMatchDecoders=s(192),e.m_IsRepDecoders=s(12),e.m_IsRepG0Decoders=s(12),e.m_IsRepG1Decoders=s(12),e.m_IsRepG2Decoders=s(12),e.m_IsRep0LongDecoders=s(192),e.m_PosSlotDecoder=s(4),e.m_PosDecoders=s(114),e.m_PosAlignDecoder=P({},4),e.m_LenDecoder=C({}),e.m_RepLenDecoder=C({}),e.m_LiteralDecoder={};for(var t=0;t<4;++t)e.m_PosSlotDecoder[t]=P({},6);return e}({}),l))throw new Error("corrupted input");for(i=0;i<64;i+=8){if(-1==(c=f(t)))throw new Error("truncated input");1==(c=c.toString(16)).length&&(c="0"+c),m=c+""+m}/^0+$|^f+$/i.test(m)?e.length_0=o:(u=parseInt(m,16),e.length_0=u>4294967295?o:d(u)),e.chunker=function(e,t,r,n){return e.m_RangeDecoder.Stream=t,x(e.m_OutWindow),e.m_OutWindow._stream=r,function(e){e.m_OutWindow._streamPos=0,e.m_OutWindow._pos=0,E(e.m_IsMatchDecoders),E(e.m_IsRep0LongDecoders),E(e.m_IsRepDecoders),E(e.m_IsRepG0Decoders),E(e.m_IsRepG1Decoders),E(e.m_IsRepG2Decoders),E(e.m_PosDecoders),function(e){var t,r;for(r=1<<e.m_NumPrevBits+e.m_NumPosBits,t=0;t<r;++t)E(e.m_Coders[t].m_Decoders)}(e.m_LiteralDecoder);for(var t=0;t<4;++t)E(e.m_PosSlotDecoder[t].Models);S(e.m_LenDecoder),S(e.m_RepLenDecoder),E(e.m_PosAlignDecoder.Models),function(e){e.Code=0,e.Range=-1;for(var t=0;t<5;++t)e.Code=e.Code<<8|f(e.Stream)}(e.m_RangeDecoder)}(e),e.state=0,e.rep0=0,e.rep1=0,e.rep2=0,e.rep3=0,e.outSize=n,e.nowPos64=a,e.prevByte=0,function(e,t){return e.decoder=t,e.encoder=null,e.alive=1,e}({},e)}(n,t,r,e.length_0)}function v(e,t){return e.output=function(e){return e.buf=s(32),e.count=0,e}({}),h(e,function(e,t){return e.buf=t,e.pos=0,e.count=t.length,e}({},t),e.output),e}function g(e){var t=e._pos-e._streamPos;t&&(!function(e,t,r,n){!function(e,t,r,n,o){for(var a=0;a<o;++a)r[n+a]=e[t+a]}(t,r,e.buf,e.count,n),e.count+=n}(e._stream,e._buffer,e._streamPos,t),e._pos>=e._windowSize&&(e._pos=0),e._streamPos=e._pos)}function w(e,t){var r=e._pos-t-1;return r<0&&(r+=e._windowSize),e._buffer[r]}function x(e){g(e),e._stream=null}function y(e){if(!e.alive)throw new Error("bad state");if(e.encoder)throw new Error("No encoding");return(function(e){var t=function(e){var t,r,n,o,a,s;if(s=l(e.nowPos64)&e.m_PosStateMask,L(e.m_RangeDecoder,e.m_IsMatchDecoders,(e.state<<4)+s)){if(L(e.m_RangeDecoder,e.m_IsRepDecoders,e.state))n=0,L(e.m_RangeDecoder,e.m_IsRepG0Decoders,e.state)?(L(e.m_RangeDecoder,e.m_IsRepG1Decoders,e.state)?(L(e.m_RangeDecoder,e.m_IsRepG2Decoders,e.state)?(r=e.rep3,e.rep3=e.rep2):r=e.rep2,e.rep2=e.rep1):r=e.rep1,e.rep1=e.rep0,e.rep0=r):L(e.m_RangeDecoder,e.m_IsRep0LongDecoders,(e.state<<4)+s)||(e.state=e.state<7?9:11,n=1),n||(n=b(e.m_RepLenDecoder,e.m_RangeDecoder,s)+2,e.state=e.state<7?8:11);else if(e.rep3=e.rep2,e.rep2=e.rep1,e.rep1=e.rep0,n=2+b(e.m_LenDecoder,e.m_RangeDecoder,s),e.state=e.state<7?7:10,(a=M(e.m_PosSlotDecoder[function(e){return(e-=2)<4?e:3}(n)],e.m_RangeDecoder))>=4){if(o=(a>>1)-1,e.rep0=(2|1&a)<<o,a<14)e.rep0+=function(e,t,r,n){var o,a,i=1,s=0;for(a=0;a<n;++a)o=L(r,e,t+i),i<<=1,i+=o,s|=o<<a;return s}(e.m_PosDecoders,e.rep0-a-1,e.m_RangeDecoder,o);else if(e.rep0+=function(e,t){var r,n,o=0;for(r=t;0!=r;--r)e.Range>>>=1,n=e.Code-e.Range>>>31,e.Code-=e.Range&n-1,o=o<<1|1-n,-16777216&e.Range||(e.Code=e.Code<<8|f(e.Stream),e.Range<<=8);return o}(e.m_RangeDecoder,o-4)<<4,e.rep0+=function(e,t){var r,n,o=1,a=0;for(n=0;n<e.NumBitLevels;++n)r=L(t,e.Models,o),o<<=1,o+=r,a|=r<<n;return a}(e.m_PosAlignDecoder,e.m_RangeDecoder),e.rep0<0)return-1==e.rep0?1:-1}else e.rep0=a;if(u(d(e.rep0),e.nowPos64)>=0||e.rep0>=e.m_DictionarySizeCheck)return-1;!function(e,t,r){var n=e._pos-t-1;for(n<0&&(n+=e._windowSize);0!=r;--r)n>=e._windowSize&&(n=0),e._buffer[e._pos++]=e._buffer[n++],e._pos>=e._windowSize&&g(e)}(e.m_OutWindow,e.rep0,n),e.nowPos64=c(e.nowPos64,d(n)),e.prevByte=w(e.m_OutWindow,0)}else t=function(e,t,r){return e.m_Coders[((t&e.m_PosMask)<<e.m_NumPrevBits)+((255&r)>>>8-e.m_NumPrevBits)]}(e.m_LiteralDecoder,l(e.nowPos64),e.prevByte),e.state<7?e.prevByte=function(e,t){var r=1;do{r=r<<1|L(t,e.m_Decoders,r)}while(r<256);return r<<24>>24}(t,e.m_RangeDecoder):e.prevByte=function(e,t,r){var n,o,a=1;do{if(o=r>>7&1,r<<=1,n=L(t,e.m_Decoders,(1+o<<8)+a),a=a<<1|n,o!=n){for(;a<256;)a=a<<1|L(t,e.m_Decoders,a);break}}while(a<256);return a<<24>>24}(t,e.m_RangeDecoder,w(e.m_OutWindow,e.rep0)),function(e,t){e._buffer[e._pos++]=t,e._pos>=e._windowSize&&g(e)}(e.m_OutWindow,e.prevByte),e.state=(m=e.state)<4?0:m<10?m-3:m-6,e.nowPos64=c(e.nowPos64,i);var m;return 0}(e.decoder);if(-1==t)throw new Error("corrupted input");e.inBytesProcessed=o,e.outBytesProcessed=e.decoder.nowPos64,(t||u(e.decoder.outSize,a)>=0&&u(e.decoder.nowPos64,e.decoder.outSize)>=0)&&(g(e.decoder.m_OutWindow),x(e.decoder.m_OutWindow),e.decoder.m_RangeDecoder.Stream=null,e.alive=0)}(e),e.alive)}function D(e,t){for(;e.m_NumPosStates<t;++e.m_NumPosStates)e.m_LowCoder[e.m_NumPosStates]=P({},3),e.m_MidCoder[e.m_NumPosStates]=P({},3)}function b(e,t,r){if(!L(t,e.m_Choice,0))return M(e.m_LowCoder[r],t);var n=8;return L(t,e.m_Choice,1)?n+=8+M(e.m_HighCoder,t):n+=M(e.m_MidCoder[r],t),n}function C(e){return e.m_Choice=s(2),e.m_LowCoder=s(16),e.m_MidCoder=s(16),e.m_HighCoder=P({},8),e.m_NumPosStates=0,e}function S(e){E(e.m_Choice);for(var t=0;t<e.m_NumPosStates;++t)E(e.m_LowCoder[t].Models),E(e.m_MidCoder[t].Models);E(e.m_HighCoder.Models)}function R(e){return e.m_Decoders=s(768),e}function P(e,t){return e.NumBitLevels=t,e.Models=s(1<<t),e}function M(e,t){var r,n=1;for(r=e.NumBitLevels;0!=r;--r)n=(n<<1)+L(t,e.Models,n);return n-(1<<e.NumBitLevels)}function L(e,t,r){var n,o=t[r];return n=(e.Range>>>11)*o,(-2147483648^e.Code)<(-2147483648^n)?(e.Range=n,t[r]=o+(2048-o>>>5)<<16>>16,-16777216&e.Range||(e.Code=e.Code<<8|f(e.Stream),e.Range<<=8),0):(e.Range-=n,e.Code-=n,t[r]=o-(o>>>5)<<16>>16,-16777216&e.Range||(e.Code=e.Code<<8|f(e.Stream),e.Range<<=8),1)}function E(e){for(var t=e.length-1;t>=0;--t)e[t]=1024}function k(e){for(var t,r,n,o=0,a=0,i=e.length,s=[],c=[];o<i;++o,++a){if(128&(t=255&e[o]))if(192==(224&t)){if(o+1>=i)return e;if(128!=(192&(r=255&e[++o])))return e;c[a]=(31&t)<<6|63&r}else{if(224!=(240&t))return e;if(o+2>=i)return e;if(128!=(192&(r=255&e[++o])))return e;if(128!=(192&(n=255&e[++o])))return e;c[a]=(15&t)<<12|(63&r)<<6|63&n}else{if(!t)return e;c[a]=t}16383==a&&(s.push(String.fromCharCode.apply(String,c)),a=-1)}return a>0&&(c.length=a,s.push(String.fromCharCode.apply(String,c))),s.join("")}function z(e){return e[1]+e[0]}return"undefined"==typeof onmessage||"undefined"!=typeof window&&void 0!==window.document||(onmessage=function(t){t&&t.data&&t.data.action==e&&p.decompress(t.data.data,t.data.cbn)}),{decompress:function(n,o,a){var i,s,c,u,m={},d=void 0===o&&void 0===a;if("function"!=typeof o&&(s=o,o=a=0),a=a||function(e){if(void 0!==s)return function(e,r){postMessage({action:t,cbn:r,result:e})}(c?e:-1,s)},o=o||function(t,r){if(void 0!==s)return postMessage({action:e,cbn:s,result:t,error:r})},d){for(m.d=v({},n);y(m.d.chunker););return k(_(m.d.output))}try{m.d=v({},n),u=z(m.d.length_0),c=u>-1,a(0)}catch(e){return o(null,e)}r((function e(){try{for(var t,n=0,s=(new Date).getTime();y(m.d.chunker);)if(++n%1e3==0&&(new Date).getTime()-s>200)return c&&(i=z(m.d.chunker.decoder.nowPos64)/u,a(i)),r(e,0),0;a(1),t=k(_(m.d.output)),r(o.bind(null,t),0)}catch(e){o(null,e)}}),0)}}}();f.LZMA=f.LZMA_WORKER=p;class _{constructor(e){this.data=e}async init(e){const t=new e(this.data.modelURL);this.model=await t.assemble(this.data)}}const h="position: absolute; top: 5vh; left: 5vw; width: 90vw; height: 90vh; border: 2px solid #0A78FC; box-shadow: 10px 10px 10px 0em rgba(0,0,0,0.5);";class v{constructor(e){this.apiURL=e,this.iframe=null,this.comlink=null}static async decompress(e){return new Promise(t=>window.LZMA.decompress(e,t))}async getComlink(){return this.comlink||await(async()=>{const e=this.iframe=document.createElement("iframe");return e.setAttribute("sandbox","allow-scripts allow-same-origin"),e.setAttribute("referrerpolicy","strict-origin"),e.src=this.apiURL,e.setAttribute("style",h),e.style.visibility="hidden",document.body.appendChild(e),this.comlink=await new Promise((t,r)=>{e.onload=async function(){const r=i(function(e,t=self,r="*"){return{postMessage:(t,n)=>e.postMessage(t,r,n),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}(e.contentWindow));t(r)},e.onerror=function(e){r(Error("Iframe failed to load: "+e.message))}}),this.comlink})()}async attemptLoad(){const e=await this.getComlink();if(console.log(await e.testVal),!await e.canDoLocalStorage()){const e=new URL(location.href);return location.assign(this.apiURL+"?redirect="+encodeURIComponent(e.origin+e.pathname)),{result:!1,message:"Redirecting to get avatar"}}{const t=await e.hasAvatar();console.log({hasAvatar:t});const r=await e.hasPermission();if(console.log({hasPermission:r}),t&&r)return{result:!0};this.iframe.style.visibility="";try{return await e.getPermission(),console.log("Permission Granted!!"),this.iframe.style.visibility="hidden",{result:!0}}catch(e){return this.iframe.style.visibility="hidden",{result:!1,message:e.message}}}}static async loadAvatarFromBase64(e){const t=[...atob(e)].map(e=>e.charCodeAt(0)-128),r=await v.decompress(t);return new _(JSON.parse(r))}async getAvatarAsJSON(){const e=await this.getComlink();return new _(await e.getAvatarAsJSON())}cleanUp(){this.iframe.parentNode.removeChild(this.iframe),this.iframe=null,this.comlink=null}}var g="\n#include <common>\nuniform sampler2D xravatar_palette;\nuniform float xravatar_offsetx;\nuniform float xravatar_offsety;\nuniform float xravatar_palettetexelsize;\n",w=`\n#ifdef USE_MAP\n    float index;\n    float bshift;\n    vec4 indexColor;\n    vec4 texelColor;\n    vec4 outColor = vec4(0.0);\n\n    float pixelSize = 1.0/2048.0;\n\n    // Center the point on the middle of the texel\n    vec2 offset = mod(vUv, pixelSize) - (0.5 * pixelSize);\n    vec2 vUv1 = vUv - offset;\n\n    // Normalise offset\n    vec2 dir = offset/abs(offset);\n    offset*=(dir/pixelSize) * 1.33333;\n\n    // Interpolate when the sampled point sits between two texels\n    float totalMix = 0.0;\n    ${[["vUv1","1.0"],["vUv1 + vec2(pixelSize * dir.x, 0.0)","offset.x"],["vUv1 + vec2(0.0, pixelSize * dir.y)","offset.y"]].map(([e,t])=>`\n        totalMix += ${t};\n        texelColor = texture2D( map,  ${e} );\n        index = floor(texelColor.r * 16.0) / 16.0 + xravatar_palettetexelsize * 0.5; // Between 0 and 1\n        bshift = smoothstep(0.0, 0.0625, mod(texelColor.r, 0.0625)); // Between 0 and 1.0\n        indexColor = texture2D( xravatar_palette, vec2(index, 1.0 - bshift) );\n        outColor += indexColor * ${t};\n    `).join("\n\n")}\n\n    diffuseColor *= mapTexelToLinear(outColor/totalMix);\n#endif\n`;const x={xravatar_index:0,xravatar_minCount:0,xravatar_maxCount:1,xravatar_minR:0,xravatar_maxR:.7,xravatar_minScale:.7,xravatar_maxScale:1.3,xravatar_canMirror:1,xravatar_canMove:0,xravatar_defaultMirror:0},y=document.createElement("canvas");y.style.width=y.style.height="auto",y.style.transform="scale(4) translate(50%,50%)";const D=y.getContext("2d"),b=[],C=16;let S,R=0;function P(e){const t=R/C;return[e%t*C,Math.floor(e/t)*C]}const M=new Uint8ClampedArray(1024);function L(e,t,r,n){for(let e=0;e<256;e++){const r=e%C,n=2*Math.floor(e/C)/16;M[4*e+0]=t[3*r+0]*n,M[4*e+1]=t[3*r+1]*n,M[4*e+2]=t[3*r+2]*n,M[4*e+3]=255}const o=new ImageData(M,C,C);e.putImageData(o,r,n)}async function E(){const e=new URLSearchParams(new URL(location.href).search).get("xravatar");if(e){return await v.loadAvatarFromBase64(e.replace(/ /gi,"+"))}}async function k(e){const t=new v(e);let r=await t.attemptLoad();if(!1===r.result)throw t.cleanUp(),Error(r.message);if(!0===r.result){const e=await t.getAvatarAsJSON();return t.cleanUp(),e}t.cleanUp()}const z=new Map;class O{constructor(e){if(z.has(e))return z.get(e);const t=new THREE.GLTFLoader;this.categoriesPromise=new Promise(r=>t.load(e,r)).then((function({scene:e}){const t={},r=[];let n,o;e.children[0].traverse(a=>{if("Group"===a.type)return;const i=a.parent===e?x:a.parent.userData;for(const e of Object.keys(x))a.userData[e]=void 0===a.userData[e]?i[e]:a.userData[e];if(n||!a.material||a.morphTargetDictionary||(n=a.material),!o&&a.material&&a.morphTargetDictionary&&(o=a.material,o.morphTargets=!0),a.material&&(a.morphTargetDictionary?a.material=o:a.material=n),a.geometry){a.castShadow=!0,r.push(a);const e=t[a.parent.name].children[a.name]={name:a.name,model:a,userData:a.userData,morphTargets:a.morphTargetDictionary&&Object.keys(a.morphTargetDictionary)};if(e.userData.xravatar_canMove){const t=a.position.length();e.startPosition={radius:t,phi:Math.atan2(a.position.z,a.position.x),theta:Math.acos(a.position.y/t)},a.position.x=0,a.position.y=0,a.position.z=0}}else{const r=a.parent===e?void 0:a.parent,n=new THREE.Group;a.add(n),t[a.name]={name:a.name,userData:a.userData,model:a,parent:r,children:{},target:n}}});const a=n.onBeforeCompile;let i={xravatar_palette:{value:(s=THREE.CanvasTexture,S=S||new s(y),S)},xravatar_offsetx:{value:0},xravatar_offsety:{value:0},xravatar_palettetexelsize:{value:1/16}};var s;return o.onBeforeCompile=n.onBeforeCompile=function(e){a(),Object.assign(e.uniforms,i),Object.assign(i,e.uniforms),e.fragmentShader=e.fragmentShader.replace("#include <map_fragment>",w),e.fragmentShader=e.fragmentShader.replace("#include <common>",g)},n.map.minFilter=n.map.magFilter=THREE.NearestFilter,r.forEach(e=>e.parent.remove(e)),{xravatar_root:e.children[0],categories:t,uniforms:i}}))}async assemble(e){const t=await this.categoriesPromise,r=t.categories,n=t.xravatar_root,o=Object.keys(r);!async function(e,t,r=!1){-1===b.indexOf(t)&&(b.push(t),r=!0);const n=b.length,o=Math.ceil(Math.sqrt(n))*C;if(o>R&&(R=o,r=!0),r)y.width=y.height=R,b.forEach((t,r)=>{const[n,o]=P(r);L(D,t,n,o),e.xravatar_offsetx&&(e.xravatar_offsetx.value=n,e.xravatar_offsety.value=o,e.xravatar_palettetexelsize.value=1/R),S&&(S.needsUpdate=!0)});else{const r=b.indexOf(t),n=b[r],[o,a]=P(r);L(D,n,o,a),e.xravatar_offsetx&&(e.xravatar_offsetx.value=o,e.xravatar_offsety.value=a,e.xravatar_palettetexelsize.value=1/R),S&&(S.needsUpdate=!0)}}(t.uniforms,e.palette);for(const t of o){const n=e[t],o=r[t].target;if(o.children.splice(0),n)if(n.children)n.children.forEach(e=>{const n=B(r,o,t,e);if(I(n,e.settings),T(n,e.settings),e.settings.xravatar_mirror){const n={};Object.assign(n,e),n.settings={},Object.assign(n.settings,e.settings),n.settings.xravatar_flip=!n.settings.xravatar_flip;const a=B(r,o,t,n);I(a,n.settings),T(a,n.settings)}});else if(n.settings.xravatar_mirror){o.parent.matrix.identity();const e={};Object.assign(e,n),e.settings={},Object.assign(e.settings,n.settings),e.settings.xravatar_flip=!e.settings.xravatar_flip;const a=B(r,o,t,n);I(a,n.settings),T(a,n.settings);const i=B(r,o,t,e);I(i,e.settings),T(i,e.settings)}else{const e=B(r,o,t,n);I(o.parent,n.settings),T(e,n.settings)}}return n.clone(!0)}}const N=new Map;function B(e,t,r,n){const o=N;let a=o.get(n);const i=e[r];if(i){if(!a){const e=i.children[n.name];if(!e)return void console.warn(`Child "${n.name}" of ${r}", from state, not found in GLTF file.`);a=e.model.clone(),o.set(n,a)}return t.add(a),a}console.warn(`"${r}", from state, not found in GLTF file.`)}function T(e,t){Object.keys(t).filter(e=>0===e.indexOf("xravatar_morph_")).forEach(r=>{const n=r.slice(15),o=e.morphTargetDictionary[n];e.morphTargetInfluences[o]=t[r]})}let A;function I(e,t){A=A||new THREE.Matrix4,e.matrixAutoUpdate=!1,e.matrix.identity();const r=t.xravatar_scale||1;t.xravatar_flip&&e.matrix.multiply(A.makeScale(1,1,-1));const n=e.oldPosition||(e.oldPosition=e.position.clone());var o,a,i;t.xravatar_positionRadius?e.matrix.multiply(A.makeTranslation(...(o=t.xravatar_positionRadius,a=t.xravatar_positionPhi,i=t.xravatar_positionTheta,[o*Math.sin(i)*Math.cos(a),o*Math.cos(i),o*Math.sin(i)*Math.sin(a)]))):e.matrix.multiply(A.makeTranslation(n.x,n.y,n.z)),e.matrix.multiply(A.makeScale(r,r,r))}export{O as Assembler,v as AvatarLoader,E as checkURL,k as getAvatar};
//# sourceMappingURL=xravatar.three.min.js.map
