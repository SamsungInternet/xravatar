<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Avatar API Endpoint</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/samsunginternet/OneUI-Web/oui-css/oui.css">
</head>
<body>
    <script type="module">
        import * as Comlink from "https://unpkg.com/comlink/dist/esm/comlink.mjs";
        import localforage from 'https://unpkg.com/localforage@1.7.3/src/localforage.js';

        let parentDomain;
        try {
            parentDomain = window.parent.location && new URL(window.parent.location.href).host
        } catch (e) {
            parentDomain = (document.referrer && new URL(document.referrer).host) || false;
        }
        document.querySelector('.viewing h1').textContent = `${parentDomain} is requesting access to your avatar.`;

        async function hasPermission() {
            const savedDomains = (await (localforage.getItem('saved-domains').catch(() => false))) || [];
            window.hasPermissionToGetAvatar = window.hasPermissionToGetAvatar || savedDomains.includes(parentDomain);
            return window.hasPermissionToGetAvatar === true;
        }

        window.addEventListener('DOMContentLoaded', async function () {
            await hasPermission();
            const avatar = await localforage.getItem('avatar').catch(() => undefined);
            document.querySelector('.avatar-target').innerHTML = 
                `<pre><code>${document.createTextNode(JSON.stringify(avatar, null, 2)).textContent}</code></pre>`
        });

        console.log('Exposing API over Comlink')
        Comlink.expose({
            testVal: 'hello world',
            hasPermission,
            async getPermission () {
                const parentEl = document.getElementById('yesno');
                const b1 = parentEl.querySelector('#yes');
                const b2 = parentEl.querySelector('#no');

                return await new Promise ((resolve, reject) => {
                    b1.addEventListener('click', function () {
                        window.hasPermissionToGetAvatar = true;
                        resolve();
                    }, {once: true});
                    b2.addEventListener('click', function () {
                        reject(Error('Permission Denied'));
                    }, {once: true});
                });
            },
            async hasAvatar() {
                const avatar = await localforage.getItem('avatar').catch(() => undefined);
                return !!avatar;
            },
            async getAvatarAsJSON() {
                if ( await hasPermission() ) {
                    const avatar = await localforage.getItem('avatar').catch(() => undefined);
                    return avatar;
                } else {
                    throw Error('No permission to retrieve avatar, run getPermission() first');
                }
            }
        }, Comlink.windowEndpoint(window.parent));
    </script>
    
    <main class="container">
        <header class="viewing">
            <h1></h1>
        </header>
        <section class="content" id="yesno">
            <button class="oui-button" id="no">Deny</button>
            <button class="oui-button" id="yes">Allow</button>
        </section>
        <section class="content avatar-target"></section>
    </main>
</body>
</html>