<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Avatar Builder</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/samsunginternet/OneUI-Web/oui-css/oui.css">
    <style>
        body {
          background-color: darkslategrey;
          /* color: white; */
        }
        canvas {
          position: fixed;
          top: 0;
          left:0;
          width: 100vw;
          height: 100vh;
        }
        .container {
          position: relative;
          height: 100vh;
        }
        nav[role="tablist"] {
            overflow-x: auto;
            white-space: nowrap;
            z-index: 2;
        }

        nav[role="tablist"] > a {
            display: inline-block;
        }

        .tabs {
          bottom: 0;
          position: absolute;
          left: 0;
          right: 0;
          padding-bottom: 5em;
        }

        .tabs > :not(:target):not(.default-fallback) {
            display: none;
        }

        .tabs > :target ~ .default-fallback {
            display: none;
        }

        .oui-bubble-item.button {
          --plus-color: var(--active);
          cursor: pointer;
        }

        .oui-bubble-item.button.disabled {
          --plus-color: var(--inactive);
          cursor: not-allowed;
        }

        .oui-bubble-item.button .plus {
          color:var(--plus-color);
          font-size: 1.8em;
          line-height: 0.556em;
          vertical-align: text-top;
        }
        
      </style>
</head>
<body>
  
  <main class="container">
    <section class="oui-viewing">
      <canvas></canvas>
    </section>
    <section id="uitarget">
    </section>
  </main>
    <script type="module">
        import { renderUI } from './lib/ui.js';
        import { renderGL } from './lib/threescene.js'
        import { createEmptySettings, defaultValues } from './lib/schema.js';
        import { GLTFLoader } from './node_modules/three/examples/jsm/loaders/GLTFLoader.js';
        import { storeAvatar, getLocalState, getState } from './lib/storage.js';
        import { init as touchInit } from './lib/touch.js';
        import './node_modules/localforage/dist/localforage.min.js';

        const loader = new GLTFLoader();

        (async function init() {
          const {scene: gltfScene} = await new Promise(resolve => loader.load('assets/bits.glb', resolve));
          const canvas = document.querySelector('canvas');

          const categories = {};
          for (const category of gltfScene.children) {

            categories[category.name] = category;
            category.childMap = {};

            // Inherit default values from the schema
            for ( const key of Object.keys(defaultValues)) {
              category.userData[key] = (category.userData[key] === undefined ? defaultValues[key] : category.userData[key]);
            }
              
            // Children inherit from their parents
            for (const child of category.children) {
              category.childMap[child.name] = child;
              for ( const key of Object.keys(category.userData)) {
                child.userData[key] = (child.userData[key] === undefined ? category.userData[key] : child.userData[key]);
              }
            }
          }
          const renderUIFn = renderUI(window.uitarget, gltfScene, {
            updateState
          });
          const updateGLState = renderGL(canvas, gltfScene);

          const state = await getState();
          const localState = await getLocalState();

          const {categoryForms, categoryTabs} = renderUIFn(state);
          async function updateState() {
            const form = this;
            const data = new FormData(form).entries();
            for (const [category, selectedItem] of data) {
              if (selectedItem) {
                const setting = state.get(category) || createEmptySettings(categories[category].childMap[selectedItem]);
                if (setting.name !== selectedItem) {
                  Object.assign(setting, createEmptySettings(categories[category].childMap[selectedItem]));
                }
                const form = this.querySelector('form');
                if (form) {
                  const settingsFormData = Object.fromEntries(new FormData(form).entries());
                  setting.data = settingsFormData;
                }
                console.log(`Setting ${category} to ${JSON.stringify(setting)}`);
                state.set(category, setting);
              } else {
                state.delete(category);
              }
            }
            renderUIFn(state, localState);
            updateGLState(state, localState);
            await storeAvatar(Object.fromEntries(state.entries()));
          }
          for (const form of categoryForms) {
            updateState.bind(form)();
          }
          touchInit(canvas, state, localState, () => updateGLState(state, localState));
          window.addEventListener('hashchange', () => renderUIFn(state), false);
        }());
    </script>
   
</body>
</html>