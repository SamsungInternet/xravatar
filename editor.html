<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Avatar Builder</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/samsunginternet/OneUI-Web/oui-css/oui.css">
    <style>
        body {
          background-color:aqua;
        }
        canvas {
          position: fixed;
          top: 0;
          left:0;
          width: 100vw;
          height: 100vh;
        }
  
        #config {
          position: fixed;
          top:0;
          left:0;
          width: 100vw;
          z-index: 10;
        }
        
      </style>
</head>
<body>
  <div id="config"></div>
  <canvas></canvas>
    <script type="module">
        
        import { GLTFLoader } from './lib/GLTFLoader.js';

        import * as THREE from './lib/three.js';
        const avatarKey = 'xravatar-avatar';
        const savedDomainsKey = 'xravatar-saved-domains'
        import localforage from 'https://unpkg.com/localforage@1.7.3/src/localforage.js';

        var loader = new GLTFLoader();

        var canvas = document.querySelector( 'canvas' );

        var camera, scene, renderer, scene;

        renderer = new THREE.WebGLRenderer( { canvas: canvas, antialias: true } );

        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth, window.innerHeight );

        scene = new THREE.Scene();
		    camera = new THREE.PerspectiveCamera();
        var group = new THREE.Group();
    
        scene.add(group);

        group.position.set(0, 0, 10);
        
        camera.lookAt(group.position);

        var light = new THREE.DirectionalLight();
        light.position.set(0, 10, 10);

        scene.add(light);

        var light2 = new THREE.DirectionalLight();
        light2.position.set(10, 10, -10);

        scene.add(light2);

        var material = new THREE.MeshStandardMaterial();

        var ser = {};
        async function serialize() {
          await localforage.setItem(avatarKey,JSON.stringify(ser));
        }
        loader.load('assets/bits.glb',
            function ( gltf ) {
             console.log(gltf)
              var s = gltf.scene;
              var pel = document.querySelector("#config");
              s.children.forEach(function(c) {
                var el = document.createElement("select");
                var cel = document.createElement("option");
                cel.textContent = "Select from "  + c.name;
                cel.setAttribute("disabled", "");
                cel.setAttribute("selected", "");
                el.appendChild(cel);
                var g = new THREE.Group();
                g.position.copy(c.position);
                g.rotation.copy(c.rotation);
                g.scale.copy(c.scale);
                
                g.name = c.name;
                ser[g.name] = null;
                group.add(g);
                c.children.forEach(function(cc) {
                  var cel = document.createElement("option");
                  cel.textContent = cel.value = cc.name;
                  el.appendChild(cel);
                  
                });
                el.addEventListener("change", function () {
                  g.children = []; // I'm a bad person I know
                  var mesh = c.children[this.selectedIndex - 1].clone();
                  //mesh.material = material;
                  g.add(mesh);
                  ser[g.name] = mesh.name;
                  serialize();
                });
                pel.appendChild(el);
              });

            }
          );

          
          renderer.setAnimationLoop(function () {
            renderer.render(scene, camera);
          });
    </script>
   
</body>
</html>